---
name: 分布式时序重构脚本
overview: 编写Python脚本从input/input.json读取约14.5万条分布式系统日志，按因果关系重建事件顺序，识别异常调用链、孤儿日志和时钟漂移事件，输出结果到output/output.json。
todos:
  - id: validate-logs
    content: 实现日志格式验证，识别malformed_logs
    status: completed
  - id: build-causal-graph
    content: 按trace_id分组并构建因果关系图（DAG）
    status: completed
    dependencies:
      - validate-logs
  - id: detect-anomalies
    content: 检测corrupted_traces、orphaned_logs、clock_skew_events
    status: completed
    dependencies:
      - build-causal-graph
  - id: topological-sort
    content: 对有效调用链执行拓扑排序生成sorted_timeline
    status: completed
    dependencies:
      - detect-anomalies
  - id: output-result
    content: 输出结果到output/output.json
    status: completed
    dependencies:
      - topological-sort
---

# 分布式时序重构 Python 脚本

## 数据概况

- 输入文件: [`input/input.json`](input/input.json)（约200万行，145,500条日志）
- 20个节点（00-19），最大时钟漂移阈值 5000ms
- 日志类型: INIT（开始）、PROCESS（处理）、END（结束）

## 核心处理逻辑

```mermaid
flowchart TD
    A[读取JSON文件] --> B[数据清洗与验证]
    B --> C{日志格式检查}
    C -->|有效| D[按trace_id分组]
    C -->|无效| E[记录malformed_logs]
    D --> F[构建因果关系图]
    F --> G[检测调用链完整性]
    G --> H{trace是否完整}
    H -->|完整| I[拓扑排序]
    H -->|不完整| J[记录corrupted_traces]
    I --> K[检测时钟漂移]
    K --> L[生成sorted_timeline]
    L --> M[输出结果]
    E --> M
    J --> M
```

## 异常检测规则

| 异常类型 | 检测规则 |

|---------|---------|

| malformed_logs | 缺少必需字段 / payload非对象类型 / 字段类型错误 |

| corrupted_traces | 缺少INIT或END事件 / causal_ref引用的log_id不存在 |

| orphaned_logs | causal_ref指向不存在的log_id（全局层面） |

| clock_skew_events | 子事件的timestamp_ms早于父事件（违反因果时序） |

## 排序策略

1. **首先**按因果关系排序（拓扑排序）
2. **同层级事件**按logical_clock升序排序
3. **logical_clock相同时**按timestamp_ms排序

## 输出文件

- 路径: [`output/output.json`](output/output.json)
- `sorted_timeline`: 仅包含完整调用链中的有效日志（按因果顺序排列）
- `anomaly_report`: 异常统计报告